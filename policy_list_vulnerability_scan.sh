#!/usr/bin/env bash

# Lists policy scan results for a specific repository in given namespace
export NAMESPACE="cloudsmith-org-neeraj" # Replace with your actual namespace
export REPO_NAME="api-assessment-repo" # You can change the repository name as needed
export API_KEY=$CLOUDSMITH_API_KEY # Ensure you have set the CLOUDSMITH_API_KEY environment variable with your API key

# Function to list policy scan results for a specific repository in human-readable format
list_policy_scan_results() {
  curl -sS\
     --request GET \
     --url "https://api.cloudsmith.io/v1/vulnerabilities/${NAMESPACE}/${REPO_NAME}/" \
     --header 'accept: application/json' \
     --header 'content-type: application/json' \
     --header "X-Api-Key: ${API_KEY}" | jq -r '.[]' | jq -r '.package.name + " - " + .package.identifier + " - " + (.has_vulnerabilities|tostring) + " - " + (.num_vulnerabilities | tostring) + " - " + (.max_severity | tostring)'

}

# Print the policy scan results in a human-readable format in Pink color
echo -e "\033[1;35m# Listing policy scan results for repository: ${REPO_NAME} in namespace: ${NAMESPACE} with the following details:\033[0m"
# print the header for the output in a tabular format and in Green color
echo -e "\033[1;32mPackage Name - Package Identifier - Has Vulnerabilities - Number of Vulnerabilities - Max Severity\033[0m"
list_policy_scan_results
